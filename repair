#!/bin/sh

pgname=$(basename "$0")
pgdir=$(dirname "$0")

. $pgdir/../functions
root_only


IFS_old=$IFS
IFS='
';
objects=( $(find / ! -path "/proc/*" ! -path "/sys/*" ! -path "/home/*" ! -path "/root/*" ! -path "/run/udev/*") )
IFS=$IFS_old

echo found ${#objects[@]}

i=0
for obj in "${objects[@]}"; do
    echo -en "\r$i"
    i=$(( i+1 ))

    #echo $obj
    #test -z "$obj" -o -L "$obj" && {
    test -z "$obj" && {
        #echo "$obj null/symlink, skip"
        #echo "$obj null, skip"
        continue;
    }

    uid=$(stat -L -c '%u' "$obj")
    gid=$(stat -L -c '%g' "$obj")

    test "$uid" -le "65535" -a "$gid" -le "65535" && {
        #echo "$obj got valid $uid:$gid, skip"
        continue;
    }

    echo -n "\r$obj $uid:$gid "
    test "$(( uid % 100000 ))" == 0 -a "$(( gid % 100000 ))" == 0 && chown -h 0:0 $obj && echo "-> 0:0"
    test "$uid" == 665536 -a "$gid" == 665536 && chown 0:0 $obj && chown -h 0:0 $obj && echo "-> 0:0"

    #chown -h $uid:$gid "$obj" && echo 'ok' || echo 'error'
    echo ''
done
